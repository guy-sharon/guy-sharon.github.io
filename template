<!DOCTYPE html>
<html>
<head>
  <title>מדריך טיולים</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Verdana, Geneva, Tahoma, sans-serif; text-align: center; 
        background: #f0f4f8; }
    button { 
      background: #0b72b9; color:  rgb(255, 255, 255); font-size: 3em; 
      padding: 10px 20px; margin: 12px 23px; border: none; border-radius: 15px;
      width: 75%;
      font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    h1 { color: #2a2344; font-size : 2.5em; margin-top: 30px; }
    h2 { font-size : 1.9em; }
  </style>

  <script>
        async function registerServiceWorker() {
            if ("serviceWorker" in navigator) {
            try {
                const registration = await navigator.serviceWorker.register(
                    "sw.js"
                );
                console.log(
                "Service Worker registered with scope:",
                registration.scope
                );
            } catch (error) {
                console.error("Service Worker registration failed:", error);
            }
            }
        }

        registerServiceWorker();
  </script>

  <script>
        // Function to check user's location
        function open_navigation(destLat, destLng, waze) {
            if (waze) {
                window.location.href = `https://waze.com/ul?ll=${destLat},${destLng}&navigate=yes`;
            }
            else {
                window.location.href = `https://www.google.com/maps/dir/?api=1&destination=${destLat},${destLng}&travelmode=walking`;
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c; // Distance in km
            return distance;
        }

        function checkLocation(destLat, destLng, placeName, verified_locations, verify_dists_km, waze) {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser.');
                return;
            }
            navigator.geolocation.getCurrentPosition((position) => {
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;
                
                // check distance to destination
                const distance = calculateDistance(userLat, userLng, destLat, destLng);
                if (distance <= 1000) { // within 1km
                    open_navigation(destLat, destLng, false);
                    return;
                }
                
                // Calculate distance in km using Haversine formula
                const R = 6371; // Earth radius in km
                all_locs = verified_locations.slice();
                // all_locs.push([destLat, destLng]);
                for (let i = 0; i < all_locs.length; i++) {
                    const vLat = all_locs[i][0];
                    const vLng = all_locs[i][1];
                    const distance = calculateDistance(userLat, userLng, vLat, vLng);
                    if (distanceV <= verify_dists_km[i]) {
                        // User is within a verified location
                        open_navigation(destLat, destLng, waze);
                        return;
                    }
                }

                var msg = "האם אתם בטוחים שברצונכם להגיע ל"
                msg += `${placeName}`
                msg += "?"
                const proceed = confirm(msg);
                if (proceed) {
                    open_navigation(destLat, destLng, waze);
                }

            }, () => {
                open_navigation(destLat, destLng, waze);
            },
            {
                maximumAge: 60000,  // use cached location up to 60s
                timeout: 500
            });
        }
    </script>
</head>
<body>
  {{BODY}}
  <script>
    function openLink(url) { window.location.href = url; }
  </script>
</body>
</html>
