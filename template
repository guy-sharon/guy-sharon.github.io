<!DOCTYPE html>
<html>
<head>
  <title>מדריך טיולים</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Verdana, Geneva, Tahoma, sans-serif; text-align: center; 
        background: #f0f4f8; }
    button { 
      background: #0b72b9; color:  rgb(255, 255, 255); font-size: 3em; 
      padding: 10px 20px; margin: 10px 23px; border: none; border-radius: 15px;
      font-family: Verdana, Geneva, Tahoma, sans-serif;
    }
    h1 { color: #2a2344; font-size : 2.5em; margin-top: 30px; }
  </style>
  <script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js');
    }
</script>
  <script>
        // Function to check user's location
        function open_navigation(destLat, destLng, waze) {
            if (waze) {
                window.location.href = `https://waze.com/ul?ll=${destLat},${destLng}&navigate=yes`;
            }
            else {
                window.location.href = `https://www.google.com/maps/dir/?api=1&destination=${destLat},${destLng}&travelmode=walking`;
            }
        }

        function checkLocation(destLat, destLng, placeName, verified_locations, verify_dists_km, waze) {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser.');
                return;
            }
            navigator.geolocation.getCurrentPosition((position) => {
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;

                // Calculate distance in km using Haversine formula
                const R = 6371; // Earth radius in km
                all_locs = verified_locations.slice();
                all_locs.push([destLat, destLng]);
                for (let i = 0; i < all_locs.length; i++) {
                    const vLat = all_locs[i][0];
                    const vLng = all_locs[i][1];
                    const dLatV = (vLat - userLat) * Math.PI / 180;
                    const dLngV = (vLng - userLng) * Math.PI / 180;
                    const aV = Math.sin(dLatV/2) * Math.sin(dLatV/2) +
                              Math.cos(userLat * Math.PI / 180) * Math.cos(vLat * Math.PI / 180) *
                              Math.sin(dLngV/2) * Math.sin(dLngV/2);
                    const cV = 2 * Math.atan2(Math.sqrt(aV), Math.sqrt(1-aV));
                    const distanceV = R * cV;
                    console.log(distanceV);
                    if (distanceV <= verify_dists_km[i]) {
                        // User is within a verified location
                        open_navigation(destLat, destLng, waze);
                        return;
                    }
                }

                var msg = "האם אתם בטוחים שברצונכם להגיע ל"
                msg += `${placeName}`
                msg += "?"
                const proceed = confirm(msg);
                if (proceed) {
                    open_navigation(destLat, destLng, waze);
                }

            }, () => {
                open_navigation(destLat, destLng, waze);
            },
            {
                maximumAge: 60000,  // use cached location up to 60s
                timeout: 500
            });
        }
    </script>
</head>
<body>
  {{BODY}}
  <script>
    function openLink(url) { window.location.href = url; }
  </script>
</body>
</html>
